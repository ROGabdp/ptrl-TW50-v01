# 模型崩潰 (Model Collapse) 與類別平衡分析報告

## 1. 問題現象
- **狀況**: Buy Agent 訓練完成後，在回測階段完全沒有進行任何交易。
- **診斷**: 經由 `diagnose_no_trade.py` 檢測，發現 AI 對於所有進場訊號都預測為「觀望 (Hold)」，機率皆為 100%。這顯示模型陷入了「策略崩潰 (Policy Collapse)」。

## 2. 原因分析：市場特性差異與資料不平衡
為什麼論文中的方法在美股有效，但在台股 (TW50) 卻失效？

- **論文環境 (美股 S&P 1500)**:
    - 論文測試期間 (2000-2019) 涵蓋了美股長多頭，唐奇安通道突破策略的自然勝率 (Base Rate) 可能接近或超過 50%。
    - 在這種環境下，AI 只要隨機買入都有不錯的期望值，因此願意嘗試交易。

- **台股環境 (TW50)**:
    - 經由 `check_balance.py` 實測，在我們的資料集中，突破策略的勝率僅為 **19.49%** (20天內漲幅 $\ge$ 10%)。
    - **獎勵機制導致的後果**:
        - **永遠觀望 (Always Wait)** 的期望得分: $0.81 \times 1 \text{ (沒賠錢)} + 0.19 \times 0 \text{ (錯失機會)} = \mathbf{0.81}$
        - **永遠買入 (Always Buy)** 的期望得分: $0.19 \times 1 \text{ (獲利)} + 0.81 \times 0 \text{ (虧損)} = \mathbf{0.19}$
    - **結論**: AI 是一個理性的分數最大化機器。它發現「什麼都不做」的分數是「嘗試買入」的 4 倍，因此它學會了最優策略——**永遠不要買股票**。

## 3. 解決方案：類別平衡 (Class Balancing)
為了打破這個僵局，我們必須干預訓練資料的分布。

- **方法**: **過採樣 (Oversampling)**
    - 修改訓練環境 (`BuyEnvPaper`)，在每一回合開始時 (`reset`)，強制以 **50% 機率** 選擇一個「成功案例 (漲幅 $\ge$ 10%)」，以 **50% 機率** 選擇一個「失敗案例」。
- **目的**:
    - 消除「死守觀望」的機率優勢。
    - 強迫 AI 不能再靠猜測背景機率混分，而必須真正去學習**哪些特徵 (Features)** 能夠區分成功與失敗的案例。
- **正規性**:
    - 這是機器學習領域處理 **不平衡資料集 (Imbalanced Dataset)** 的標準且正規做法。
    - 常見應用場景：詐欺偵測 (99% 正常 vs 1% 盜刷)、罕見疾病預測。

## 4. 副作用與應對策略
實作類別平衡後，模型不再反映真實世界的機率分布，而是反映人工調整後的 50/50 分布。

- **副作用**: **過度樂觀 (Over-optimism)**
    - 模型在訓練時覺得勝率有一半，因此在回測真實世界 (勝率僅 20%) 時，會變得比較激進，容易發出買入訊號。
    - 這可能導致較多的 **假警報 (False Positives)**，即買入後並未上漲。

- **應對策略**: **調整決策門檻 (Threshold Adjustment)**
    - 由於模型信心被放大，我們不應再使用預設的 `機率 > 0.5` 作為買入標準。
    - **建議做法**: 提高買入門檻，例如要求 `預測機率 > 0.7` 或 `0.8` 才執行交易。
    - **論文佐證**: 論文中的 **Sell Agent** 正是採用了 **0.85** 的高門檻才執行賣出，這暗示了作者在處理類似問題時也採取了提高門檻的策略來過濾雜訊。

## 5. 總結
在台股這種高效率或盤整較多的市場中，單純模仿論文的獎勵機制會導致 AI 消極怠工。透過 **類別平衡** 強迫學習，並配合 **提高門檻** 進行風險控管，是讓 AI 在此類市場中恢復交易能力的有效策略。

## 6. 實作成果 (2025/12/02 更新)
在實作類別平衡 (Class Balancing) 並重新訓練後，模型表現出現了顯著的改善：

- **交易行為**: AI 從「完全不交易」轉變為「積極交易」。
- **績效表現**:
    - **期初資金**: 999,430
    - **期末資金**: 2,118,823
    - **總報酬率**: **+112%** (資金翻倍)
- **結論**:
    - 類別平衡策略成功打破了模型崩潰的僵局。
    - AI 願意承擔風險去捕捉獲利機會，且選股能力展現出實戰價值。
    - 未來可進一步觀察回撤 (MDD) 狀況，若過於激進，可透過提高信心門檻 (如 > 0.7) 來進行微調。
